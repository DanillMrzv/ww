#!/bin/bash

clear
mkdir -p ~/.cloudshell && touch ~/.cloudshell/no-apt-get-warning
echo "Установка зависимостей..."
sudo apt-get update -y --fix-missing && sudo apt-get install wireguard-tools jq -y --fix-missing

priv="${1:-\$(wg genkey)}"
pub="${2:-\$(echo "\${priv}" | wg pubkey)}"
api="https://api.cloudflareclient.com/v0i1909051800"
ins() { curl -s -H 'user-agent:' -H 'content-type: application/json' -X "$1" "${api}/$2" "${@:3}"; }
sec() { ins "$1" "$2" -H "authorization: Bearer $3" "${@:4}"; }
response=$(ins POST "reg" -d "{\"install_id\":\"\",\"tos\":\"\$(date -u +%FT%T.000Z)\",\"key\":\"\${pub}\",\"fcm_token\":\"\",\"type\":\"ios\",\"locale\":\"en_US\"}")

id=$(echo "$response" | jq -r '.result.id')
token=$(echo "$response" | jq -r '.result.token')
response=$(sec PATCH "reg/${id}" "$token" -d '{"warp_enabled":true}')
peer_pub=$(echo "$response" | jq -r '.result.config.peers[0].public_key')
peer_endpoint=$(echo "$response" | jq -r '.result.config.peers[0].endpoint.host')
client_ipv4=$(echo "$response" | jq -r '.result.config.interface.addresses.v4')
client_ipv6=$(echo "$response" | jq -r '.result.config.interface.addresses.v6')
port=$(echo "$peer_endpoint" | sed 's/.*:\([0-9]*\)$/\1/')
peer_endpoint=$(echo "$peer_endpoint" | sed 's/:[0-9]*$/162.159.193.5/')

conf=$(cat <<-EOM
[Interface]
PrivateKey = ${priv}
S1 = 0
S2 = 0
Jc = 120
Jmin = 23
Jmax = 911
H1 = 1
H2 = 2
H3 = 3
H4 = 4
Address = ${client_ipv4}, ${client_ipv6}
DNS = 1.1.1.1, 2606:4700:4700::1111, 1.0.0.1, 2606:4700:4700::1001
MTU = 1420

[Peer]
PublicKey = ${peer_pub}
AllowedIPs = 162.159.128.0/24, 162.159.129.0/24, 162.159.130.0/24, 162.159.133.0/24, 162.159.134.0/24, 162.159.135.0/24, 162.159.136.0/24, 162.159.137.0/24, 162.159.138.0/24, 142.250.178.0/24, 142.250.179.0/24, 142.250.180.0/24, 142.250.181.0/24, 142.250.184.0/24, 142.250.185.0/24, 142.250.186.0/24, 142.250.200.0/24, 142.250.201.0/24, 142.250.203.0/24, 142.250.219.0/24, 142.250.74.0/24, 142.251.128.0/24, 142.251.129.0/24, 142.251.132.0/24, 142.251.143.0/24, 142.251.209.0/24, 142.251.36.0/24, 142.251.39.0/24, 172.217.16.0/24, 172.217.168.0/24, 172.217.17.0/24, 172.217.18.0/24, 172.217.23.0/24, 172.217.29.0/24, 172.217.30.0/24, 204.11.56.0/24, 216.58.204.0/24, 216.58.205.0/24, 216.58.206.0/24, 216.58.209.0/24, 216.58.212.0/24, 216.58.215.0/24, 23.227.38.0/24, 138.128.140.0/24, 172.65.202.0/24, 34.0.129.0/24, 34.0.130.0/24, 34.0.131.0/24, 34.0.132.0/24, 34.0.133.0/24, 34.0.134.0/24, 34.0.135.0/24, 34.0.136.0/24, 34.0.137.0/24, 34.0.139.0/24, 34.0.140.0/24, 34.0.141.0/24, 34.0.142.0/24, 34.0.144.0/24, 34.0.145.0/24, 34.0.146.0/24, 34.0.148.0/24, 34.0.149.0/24, 34.0.151.0/24, 34.0.153.0/24, 34.0.155.0/24, 34.0.156.0/24, 34.0.157.0/24, 34.0.158.0/24, 34.0.159.0/24, 34.0.192.0/24, 34.0.193.0/24, 34.0.194.0/24, 34.0.195.0/24, 34.0.196.0/24, 34.0.197.0/24, 34.0.198.0/24, 34.0.199.0/24, 34.0.200.0/24, 34.0.201.0/24, 34.0.202.0/24, 34.0.203.0/24, 34.0.204.0/24, 34.0.205.0/24, 34.0.206.0/24, 34.0.207.0/24, 34.0.208.0/24, 34.0.209.0/24, 34.0.210.0/24, 34.0.211.0/24, 34.0.212.0/24, 34.0.213.0/24, 34.0.215.0/24, 34.0.216.0/24, 34.0.217.0/24, 34.0.218.0/24, 34.0.220.0/24, 34.0.221.0/24, 34.0.222.0/24, 34.0.223.0/24, 34.0.227.0/24, 34.0.240.0/24, 34.0.241.0/24, 34.0.242.0/24, 34.0.243.0/24, 34.0.244.0/24, 34.0.245.0/24, 34.0.246.0/24, 34.0.247.0/24, 34.0.248.0/24, 34.0.249.0/24, 34.0.250.0/24, 34.0.251.0/24, 34.0.48.0/24, 34.0.49.0/24, 34.0.50.0/24, 34.0.51.0/24, 34.0.52.0/24, 34.0.53.0/24, 34.0.54.0/24, 34.0.55.0/24, 34.0.56.0/24, 34.0.57.0/24, 34.0.59.0/24, 34.0.60.0/24, 34.0.62.0/24, 34.0.63.0/24, 34.0.64.0/24, 34.0.65.0/24, 34.0.66.0/24, 34.0.82.0/24, 34.1.216.0/24, 34.1.221.0/24, 35.207.100.0/24, 35.207.101.0/24, 35.207.103.0/24, 35.207.104.0/24, 35.207.106.0/24, 35.207.107.0/24, 35.207.108.0/24, 35.207.109.0/24, 35.207.110.0/24, 35.207.111.0/24, 35.207.114.0/24, 35.207.115.0/24, 35.207.116.0/24, 35.207.117.0/24, 35.207.121.0/24, 35.207.122.0/24, 35.207.124.0/24, 35.207.125.0/24, 35.207.126.0/24, 35.207.129.0/24, 35.207.131.0/24, 35.207.132.0/24, 35.207.135.0/24, 35.207.136.0/24, 35.207.137.0/24, 35.207.139.0/24, 35.207.140.0/24, 35.207.141.0/24, 35.207.142.0/24, 35.207.143.0/24, 35.207.144.0/24, 35.207.145.0/24, 35.207.146.0/24, 35.207.147.0/24, 35.207.149.0/24, 35.207.150.0/24, 35.207.151.0/24, 35.207.153.0/24, 35.207.154.0/24, 35.207.155.0/24, 35.207.156.0/24, 35.207.157.0/24, 35.207.158.0/24, 35.207.160.0/24, 35.207.162.0/24, 35.207.163.0/24, 35.207.164.0/24, 35.207.165.0/24, 35.207.166.0/24, 35.207.167.0/24, 35.207.168.0/24, 35.207.170.0/24, 35.207.171.0/24, 35.207.172.0/24, 35.207.174.0/24, 35.207.176.0/24, 35.207.178.0/24, 35.207.180.0/24, 35.207.181.0/24, 35.207.182.0/24, 35.207.184.0/24, 35.207.185.0/24, 35.207.186.0/24, 35.207.187.0/24, 35.207.188.0/24, 35.207.189.0/24, 35.207.190.0/24, 35.207.191.0/24, 35.207.193.0/24, 35.207.195.0/24, 35.207.196.0/24, 35.207.198.0/24, 35.207.199.0/24, 35.207.201.0/24, 35.207.202.0/24, 35.207.205.0/24, 35.207.207.0/24, 35.207.209.0/24, 35.207.210.0/24, 35.207.211.0/24, 35.207.213.0/24, 35.207.214.0/24, 35.207.220.0/24, 35.207.221.0/24, 35.207.222.0/24, 35.207.224.0/24, 35.207.225.0/24, 35.207.227.0/24, 35.207.229.0/24, 35.207.232.0/24, 35.207.234.0/24, 35.207.238.0/24, 35.207.240.0/24, 35.207.245.0/24, 35.207.249.0/24, 35.207.250.0/24, 35.207.251.0/24, 35.207.64.0/24, 35.207.65.0/24, 35.207.67.0/24, 35.207.71.0/24, 35.207.72.0/24, 35.207.73.0/24, 35.207.74.0/24, 35.207.75.0/24, 35.207.76.0/24, 35.207.77.0/24, 35.207.78.0/24, 35.207.79.0/24, 35.207.80.0/24, 35.207.81.0/24, 35.207.82.0/24, 35.207.83.0/24, 35.207.84.0/24, 35.207.85.0/24, 35.207.86.0/24, 35.207.87.0/24, 35.207.89.0/24, 35.207.91.0/24, 35.207.92.0/24, 35.207.95.0/24, 35.207.97.0/24, 35.207.99.0/24, 35.212.102.0/24, 35.212.111.0/24, 35.212.117.0/24, 35.212.12.0/24, 35.212.120.0/24, 35.212.4.0/24, 35.212.88.0/24, 35.213.0.0/24, 35.213.10.0/24, 35.213.101.0/24, 35.213.102.0/24, 35.213.105.0/24, 35.213.106.0/24, 35.213.107.0/24, 35.213.109.0/24, 35.213.11.0/24, 35.213.110.0/24, 35.213.111.0/24, 35.213.115.0/24, 35.213.12.0/24, 35.213.120.0/24, 35.213.122.0/24, 35.213.124.0/24, 35.213.125.0/24, 35.213.126.0/24, 35.213.127.0/24, 35.213.128.0/24, 35.213.129.0/24, 35.213.13.0/24, 35.213.130.0/24, 35.213.131.0/24, 35.213.132.0/24, 35.213.133.0/24, 35.213.134.0/24, 35.213.135.0/24, 35.213.136.0/24, 35.213.137.0/24, 35.213.138.0/24, 35.213.139.0/24, 35.213.1
